from datetime import datetime

import pybars
from core.domain import TicketRecord
from common.repository import compiler


greet = "\n".join((
    "ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ‘Ğ°ÑƒĞ¼Ğ°Ğ½ĞµÑ†!",
    "Ğ Ğ°Ğ´Ñ‹ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ñ‚ĞµĞ±Ñ Ğ² Ğ½Ğ°ÑˆĞµĞ¼ Ğ±Ğ¾Ñ‚Ğµ! Ğ—Ğ´ĞµÑÑŒ Ñ‚Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ:",
    "ğŸ”¹ Ğ—Ğ°Ğ´Ğ°Ñ‚ÑŒ Ğ»ÑĞ±Ñ‹Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚ĞµĞ±Ñ Ğ²Ğ¾Ğ»Ğ½ÑƒÑÑ‚.",
    "ğŸ”¹ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ¸Ñ‚ÑŒ Ğ¾ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºÑˆĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğµ.",
    "ğŸ”¹ ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ¸Ğ´ĞµÑ.",
))

create_ticket = \
    "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ."

choice_issue = "\n".join((
    "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ñ‚Ğ¸Ğ¿ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ:",
    "ğŸ”§ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° â€“ Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ğ¸, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ.",
    "â“ Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ â€“ Ğ·Ğ°Ğ´Ğ°Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒÑÑ‰Ğ¸Ğ¹ Ñ‚ĞµĞ±Ñ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ.",
    "ğŸ’¡ ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â€“ Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸ÑÑŒ ÑĞ²Ğ¾Ğ¸Ğ¼Ğ¸ Ğ¸Ğ´ĞµÑĞ¼Ğ¸ Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ‚Ğ¸Ğ²Ğ°Ğ¼Ğ¸!",
))

choice_category = \
    "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ, Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ ÑĞ²ÑĞ·Ğ°Ğ½Ğ¾ Ñ‚Ğ²Ğ¾Ñ‘ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ."

choice_privacy = "\n".join((
    "ğŸ¤« Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ğ¾?",
    "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ â€“ Ğ½Ğ°Ñˆ Ğ»ÑƒÑ‡ÑˆĞ¸Ğ¹ Ğ´Ñ€ÑƒĞ³ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ğ°Ñ!"
))

input_full_name = "\n".join((
    "âœï¸ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ ÑĞ²Ğ¾Ñ‘ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ğ¤Ğ˜Ğ",
    "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒĞºĞ°Ğ¶Ğ¸ Ğ¸Ğ¼Ñ Ğ¸ Ñ„Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ, Ğ¸ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¾Ñ‚Ñ‡ĞµÑÑ‚Ğ²Ğ¾.",
    "ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ½Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‡"
))


input_study_group = \
    "ğŸ“ ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ ÑĞ²Ğ¾ĞµĞ¹ ÑƒÑ‡ĞµĞ±Ğ½Ğ¾Ğ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹. Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ²Ğ²Ğ¾Ğ´Ğ°: Ğ˜Ğ£13-13Ğ‘."

input_text = \
    "ğŸ“© ĞĞ¿Ğ¸ÑˆĞ¸ Ğ½Ğ¸Ğ¶Ğµ ÑĞ²Ğ¾Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ:"

choice_approve = \
    "ğŸ‘€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ, Ğ²ÑÑ‘ Ğ»Ğ¸ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾. ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑˆÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ?"


def ticket_sent(ticket_id: int) -> str:
    return f"Ğ¢Ğ²Ğ¾Ñ‘ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾! Ğ•Ğ¼Ñƒ Ğ¿Ñ€Ğ¸ÑĞ²Ğ¾Ğ¸Ğ»Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ #{ticket_id}"


ticket_channel_template = compiler.compile("""
ĞĞ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ #{{ticket.id}}
=================================
ğŸ“Œ Ğ¢Ğ¸Ğ¿: {{as_tag ticket.issue}}
ğŸ“‚ ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ: {{as_tag ticket.category}}
ğŸ‘¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ: {{#if ticket.owner}}{{ticket.owner}}{{else}}Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ğ¾{{/if}}
ğŸ•’ Ğ”Ğ°Ñ‚Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸: {{as_date ticket.opened_at}}
=================================
ğŸ“© Ğ¢ĞµĞºÑÑ‚ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ:
{{ticket.text}}
""")


def ticket_channel(ticket: TicketRecord) -> str:
    return ticket_channel_template(
        {
            "ticket": ticket,
        },
        helpers={
            "as_tag": as_tag,
            "as_date": as_date,
        }
    )


def as_tag(this, s) -> str:
    return "#" + s.lower().replace(" ", "")


def as_date(this, dt: datetime, date_format: str = None) -> str:
    return datetime.strftime(dt, date_format or "%d.%m.%Y %H:%M:%S")
